// Importing Node.js file server module
var fs = require('fs');

// Defining paths to make is easier throughout the developing.
const ABSOLUTE_PATH = __dirname + '/../../data';
const UPLOADS_PATH = __dirname + '/../views';
const USER_FILE = '/users.json';
const PRODUCT_FILE = '/products.json';


class db {
    constructor() {
        this.users = this.openFile(USER_FILE);
        this.products = this.openFile(PRODUCT_FILE);
    }
    
    // Save the database file
    saveFile(fileName, contentString) {
        fs.writeFileSync(ABSOLUTE_PATH + fileName, contentString);
    }

    // Open file the database file
    openFile(fileName) {
        const file = fs.readFileSync(ABSOLUTE_PATH + fileName);
        return JSON.parse(file);
    }

    // Save the user as a JSON object.
    saveUser(user) {
        this.users.push(user);
        this.saveFile(USER_FILE, JSON.stringify(this.users));
    }
    // Deletes the user.
    deleteUser(user) {
        this.users = this.users.filter(x => x.email != user.email);
        this.saveFile(USER_FILE, JSON.stringify(this.users));
    }
    // Finds the user, used for eg. checking "My products listed for sale".
    findUser(user) {
        return this.users.find(x => user.email == x.email);
    }
    // Update password
    updateUserPassword(user, newPassword) {
        // Modify the password of the matching user only
        this.users = this.users.map(x => {
            if (x.email === user.email) {
                x.password = newPassword;
            }
            return x;
        });

        this.saveFile(USER_FILE, JSON.stringify(this.users));
    }

    /* Product methods */
    saveProduct(product) {
        this.products.push(product);
        this.saveFile(PRODUCT_FILE, JSON.stringify(this.products));
    }

    deleteProduct(product) {
        // Remove product image from the 'uploads' folder. If not doing this, in the long run upload upload folder would become crowded.
        fs.unlinkSync(UPLOADS_PATH + product.picturePath);
        // Remove product data (everything in the json object.)
        this.products = this.products.filter(x => x.id !== product.id);
        this.saveFile(PRODUCT_FILE, JSON.stringify(this.products));
    }

    findProduct(productId) {
        return this.products.find(x => x.id === productId);
    }

    updateProductPrice(product, newPrice) {
        // Modify the price of the matching product only
        // using the ID generated by UUID.
        this.products = this.products.map(x => {
            if (x.id === product.id) {
                x.price = newPrice;
            }
            return x;
        });

        this.saveFile(PRODUCT_FILE, JSON.stringify(this.products));
    }

    findMyProducts(email) {
        return this.products.filter(x => x.userEmail === email);
    }

    findAllProducts() {
        return this.products;
    }
}

module.exports = new db();